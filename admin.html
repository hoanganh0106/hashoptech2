<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - HaShopTech</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <div class="login-header">
                <i class="fas fa-shield-alt"></i>
                <h1>Admin Panel</h1>
                <p>Đăng nhập để quản lý hệ thống</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Tên đăng nhập</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Mật khẩu</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-sign-in-alt"></i> Đăng nhập
                </button>
            </form>
            <div id="loginError" class="error-message"></div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="dashboard-page" style="display: none;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-user-shield"></i>
                <span>Admin Panel</span>
            </div>
            <nav class="sidebar-menu">
                <a href="#" class="menu-item active" data-page="dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="menu-item" data-page="orders">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Đơn hàng</span>
                </a>
                <a href="#" class="menu-item" data-page="products">
                    <i class="fas fa-box"></i>
                    <span>Sản phẩm</span>
                </a>
                <a href="#" class="menu-item" data-page="accounts">
                    <i class="fas fa-key"></i>
                    <span>Kho tài khoản</span>
                </a>
                <a href="#" class="menu-item" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span>Cài đặt</span>
                </a>
                <a href="#" class="menu-item" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Đăng xuất</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <h2 id="pageTitle">Dashboard</h2>
                <div class="header-actions">
                    <span class="admin-name">
                        <i class="fas fa-user-circle"></i>
                        <span id="adminUsername">Admin</span>
                    </span>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div id="dashboardContent" class="content-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statTotalOrders">0</h3>
                            <p>Tổng đơn hàng</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statPendingOrders">0</h3>
                            <p>Chờ thanh toán</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statPaidOrders">0</h3>
                            <p>Đã thanh toán</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statRevenue">0đ</h3>
                            <p>Doanh thu</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statProducts">0</h3>
                            <p>Sản phẩm</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                            <i class="fas fa-key"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statAccounts">0</h3>
                            <p>Tài khoản trong kho</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders Content -->
            <div id="ordersContent" class="content-section" style="display: none;">
                <div class="filter-bar">
                    <select id="orderStatusFilter" class="filter-select">
                        <option value="">Tất cả đơn hàng</option>
                        <option value="pending">Chờ thanh toán</option>
                        <option value="paid">Đã thanh toán</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadOrders()">
                        <i class="fas fa-sync"></i> Làm mới
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Email</th>
                                <th>Số tiền</th>
                                <th>Thanh toán</th>
                                <th>Giao hàng</th>
                                <th>Ngày tạo</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="8" class="text-center">Đang tải...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Products Content -->
            <div id="productsContent" class="content-section" style="display: none;">
                <div class="filter-bar">
                    <button class="btn btn-primary" id="btnAddProduct">
                        <i class="fas fa-plus"></i> Thêm sản phẩm
                    </button>
                </div>
                <div class="products-grid" id="productsGrid">
                    <!-- Products will be loaded here -->
                </div>
            </div>

            <!-- Accounts Content -->
            <div id="accountsContent" class="content-section" style="display: none;">
                <div class="filter-bar" id="accountsFilterBar">
                    <select id="accountProductFilter" class="filter-select" onchange="loadAccountsByProduct()">
                        <option value="">Chọn sản phẩm</option>
                    </select>
                    <select id="accountVariantFilter" class="filter-select" style="display:none;" onchange="loadAccountsByProduct()">
                        <option value="">Tất cả gói</option>
                    </select>
                    <select id="accountStatusFilter" class="filter-select" onchange="loadAccountsByProduct()">
                        <option value="">Tất cả trạng thái</option>
                        <option value="available">Còn hàng</option>
                        <option value="sold">Đã bán</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadAccountsByProduct()">
                        <i class="fas fa-sync"></i> Làm mới
                    </button>
                </div>
                
                <!-- BUTTON RIÊNG BIỆT - KHÔNG NẰM TRONG FILTER BAR -->
                <div style="margin-bottom: 1rem;">
                    <div id="addAccountButtonContainer"></div>
                </div>
                
                <!-- Stock Summary -->
                <div id="stockSummary" class="stock-summary" style="display:none; margin-bottom: 1.5rem;">
                    <div class="stat-cards-row" id="variantStockCards"></div>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">STT</th>
                                <th>Gói</th>
                                <th>Username</th>
                                <th>Password</th>
                                <th>Thông tin thêm</th>
                                <th style="width: 120px;">Trạng thái</th>
                                <th style="width: 150px;">Ngày thêm</th>
                                <th style="width: 100px;">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                            <tr>
                                <td colspan="8" class="text-center">Chọn sản phẩm để xem tài khoản</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Content -->
            <div id="settingsContent" class="content-section" style="display: none;">
                <div class="settings-container">
                    <div class="settings-card">
                        <h3><i class="fas fa-lock"></i> Đổi mật khẩu</h3>
                        <form id="changePasswordForm">
                            <div class="form-group">
                                <label>Mật khẩu cũ</label>
                                <input type="password" id="oldPassword" required>
                            </div>
                            <div class="form-group">
                                <label>Mật khẩu mới</label>
                                <input type="password" id="newPassword" required>
                            </div>
                            <div class="form-group">
                                <label>Xác nhận mật khẩu mới</label>
                                <input type="password" id="confirmPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Đổi mật khẩu
                            </button>
                        </form>
                    </div>
                    <div class="settings-card">
                        <h3><i class="fab fa-telegram"></i> Cấu hình Telegram</h3>
                        <p>Bot Token và Chat ID được cấu hình trong file <code>config.js</code></p>
                        <button class="btn btn-secondary" onclick="testTelegram()">
                            <i class="fas fa-test"></i> Test kết nối
                        </button>
                    </div>
                    <div class="settings-card">
                        <h3><i class="fas fa-credit-card"></i> Cấu hình Sepay</h3>
                        <p>API Key và thông tin ngân hàng được cấu hình trong file <code>config.js</code></p>
                        <button class="btn btn-secondary" onclick="testSepay()">
                            <i class="fas fa-test"></i> Test kết nối
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeOrderModal()">&times;</span>
            <div id="orderModalBody"></div>
        </div>
    </div>

    <!-- Product Modal (for add/edit product) -->
    <div id="productModal" class="modal" onclick="if(event.target === this) { this.style.display='none'; this.classList.remove('show'); }">
        <div class="modal-content">
            <span class="close-modal" id="closeModalBtn" onclick="document.getElementById('productModal').style.display='none'; document.getElementById('productModal').classList.remove('show'); return false;">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="addAccountModal" class="modal" onclick="if(event.target === this) { this.style.display='none'; this.classList.remove('active'); document.getElementById('addAccountForm').reset(); document.getElementById('variantSelectGroup').style.display='none'; }">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-modal" onclick="document.getElementById('addAccountModal').style.display='none'; document.getElementById('addAccountModal').classList.remove('active'); document.getElementById('addAccountForm').reset(); document.getElementById('variantSelectGroup').style.display='none'; return false;">&times;</span>
            <div id="addAccountModalBody">
                <h2><i class="fas fa-plus-circle"></i> Thêm Tài Khoản Vào Kho</h2>
                <form id="addAccountForm" onsubmit="submitAddAccounts(event)">
                    <div class="form-group">
                        <label>Sản phẩm *</label>
                        <select id="addAccountProduct" class="form-input" required onchange="loadVariantsForAdd()">
                            <option value="">Chọn sản phẩm</option>
                        </select>
                    </div>

                    <div class="form-group" id="variantSelectGroup" style="display:none;">
                        <label>Gói/Option *</label>
                        <select id="addAccountVariant" class="form-input" required>
                            <option value="">Chọn gói</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            Danh sách tài khoản *
                            <small style="color:#666; font-weight:normal;">(Mỗi dòng: username|password hoặc username|password|ghi chú)</small>
                        </label>
                        <textarea id="addAccountList" class="form-textarea" rows="10" required placeholder="user1@example.com|pass123&#10;user2@example.com|pass456|Tài khoản VIP&#10;user3@example.com|pass789"></textarea>
                        <small style="color:#666;">
                            <i class="fas fa-info-circle"></i> 
                            Mỗi dòng một tài khoản, dùng dấu | để phân cách username, password và ghi chú (optional)
                        </small>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary" style="flex:1;">
                            <i class="fas fa-save"></i> Lưu tài khoản
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('addAccountModal').style.display='none'; document.getElementById('addAccountModal').classList.remove('active'); document.getElementById('addAccountForm').reset(); document.getElementById('variantSelectGroup').style.display='none'; return false;">
                            <i class="fas fa-times"></i> Hủy
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="admin-script.js"></script>
    <script src="admin-products.js"></script>
    <script src="admin-stock.js"></script>
    <script>
    // TẠO NÚT ĐỘNG VỚI MUTATIONOBSERVER - SOLUTION CUỐI CÙNG
    (function() {
        console.log('🚀 Initializing Add Account Button with MutationObserver...');
        
        let currentButton = null;
        
        function createAddAccountButton() {
            const container = document.getElementById('addAccountButtonContainer');
            if (!container) {
                console.warn('⚠️ Container not found yet');
                return null;
            }
            
            // Nếu đã có button và vẫn hoạt động, không tạo lại
            if (currentButton && currentButton.parentNode === container && currentButton.onclick) {
                console.log('✅ Button already exists and working');
                return currentButton;
            }
            
            console.log('🔨 Creating new button...');
            
            // Tạo nút mới hoàn toàn
            const button = document.createElement('button');
            button.className = 'btn btn-primary';
            button.id = 'btnAddAccountFinal';
            button.style.cssText = 'position: relative; z-index: 9999 !important; cursor: pointer !important; pointer-events: auto !important;';
            button.type = 'button';
            button.innerHTML = '<i class="fas fa-plus"></i> Thêm tài khoản';
            
            // Attach click handler
            button.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('🎯 BUTTON CLICKED!');
                
                const modal = document.getElementById('addAccountModal');
                if (!modal) {
                    alert('Không tìm thấy modal!');
                    return false;
                }
                
                modal.style.display = 'block';
                modal.classList.add('active');
                console.log('✅ Modal opened');
                
                // Load products
                fetch(window.location.origin + '/api/products')
                    .then(r => r.json())
                    .then(data => {
                        if (data.success && data.products && data.products.length > 0) {
                            const select = document.getElementById('addAccountProduct');
                            if (select) {
                                select.innerHTML = '<option value="">Chọn sản phẩm</option>' +
                                    data.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                                console.log('✅ Products loaded:', data.products.length);
                            }
                        }
                    })
                    .catch(err => console.error('❌ Error:', err));
                
                return false;
            };
            
            // Clear và insert
            container.innerHTML = '';
            container.appendChild(button);
            currentButton = button;
            console.log('✅ Button created successfully');
            
            return button;
        }
        
        // Setup MutationObserver để tự động tạo lại button
        function setupObserver() {
            const container = document.getElementById('addAccountButtonContainer');
            if (!container) {
                setTimeout(setupObserver, 100);
                return;
            }
            
            console.log('👁️ Setting up MutationObserver...');
            
            const observer = new MutationObserver(function(mutations) {
                console.log('🔄 DOM changed, checking button...');
                // Kiểm tra button còn tồn tại không
                const btn = document.getElementById('btnAddAccountFinal');
                if (!btn || !btn.onclick) {
                    console.log('⚠️ Button missing or broken, recreating...');
                    createAddAccountButton();
                }
            });
            
            // Quan sát container và parent của nó
            observer.observe(container, {
                childList: true,
                subtree: true,
                attributes: true
            });
            
            // Quan sát filter bar
            const filterBar = document.getElementById('accountsFilterBar');
            if (filterBar) {
                observer.observe(filterBar, {
                    childList: true,
                    subtree: true
                });
            }
            
            console.log('✅ Observer active');
        }
        
        // Init
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                createAddAccountButton();
                setupObserver();
            });
        } else {
            createAddAccountButton();
            setupObserver();
        }
        
        // Hook navigate
        const originalNavigate = window.navigateToPage;
        window.navigateToPage = function(page) {
            if (typeof originalNavigate === 'function') {
                originalNavigate.apply(this, arguments);
            }
            if (page === 'accounts') {
                setTimeout(createAddAccountButton, 200);
            }
        };
        
        // Expose global
        window.forceRecreateAddAccountButton = createAddAccountButton;
        
        // Tạo lại button mỗi 2 giây (fallback cuối cùng)
        setInterval(function() {
            const btn = document.getElementById('btnAddAccountFinal');
            if (!btn || !btn.parentNode) {
                console.log('⏰ Periodic check: button missing, recreating...');
                createAddAccountButton();
            }
        }, 2000);
    })();
    </script>
</body>
</html>

