<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Panel - HaShopTech</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin-style.css?v=20241227">
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <div class="login-header">
                <i class="fas fa-shield-alt"></i>
                <h1>Admin Panel</h1>
                <p>Đăng nhập để quản lý hệ thống</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">Tên đăng nhập</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Mật khẩu</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-sign-in-alt"></i> Đăng nhập
                </button>
                <div id="loginError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="admin-dashboard" style="display: none;">
        <!-- Header -->
        <header class="admin-header">
            <button class="mobile-menu-toggle" id="mobileMenuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="header-left">
                <h1><i class="fas fa-tachometer-alt"></i> Admin Panel</h1>
            </div>
            <div class="header-right">
                <span id="adminUsername" class="admin-name">Admin</span>
                <button class="btn btn-warning" onclick="clearCache()" title="Xóa cache">
                    <i class="fas fa-refresh"></i>
                </button>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </div>
        </header>

        <!-- Sidebar -->
        <nav class="admin-sidebar">
            <ul class="sidebar-menu">
                <li class="menu-item active" data-page="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Tổng quan
                </li>
                <li class="menu-item" data-page="products">
                    <i class="fas fa-box"></i> Sản phẩm
                </li>
                <li class="menu-item" data-page="orders">
                    <i class="fas fa-shopping-cart"></i> Đơn hàng
                </li>
                <li class="menu-item" data-page="accounts">
                    <i class="fas fa-database"></i> Kho tài khoản
                </li>
                <li class="menu-item" data-page="settings">
                    <i class="fas fa-cog"></i> Cài đặt
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="admin-content">
            <!-- Dashboard Content -->
            <div id="dashboardContent" class="content-section active">
                <div class="section-header">
                    <h2><i class="fas fa-tachometer-alt"></i> Tổng quan hệ thống</h2>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalProducts">0</h3>
                            <p>Tổng sản phẩm</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalOrders">0</h3>
                            <p>Tổng đơn hàng</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalRevenue">0đ</h3>
                            <p>Doanh thu</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalAccounts">0</h3>
                            <p>Tài khoản trong kho</p>
                        </div>
                    </div>
                </div>

                <div class="recent-orders">
                    <h3><i class="fas fa-clock"></i> Đơn hàng gần đây</h3>
                    <div id="recentOrdersList" class="orders-list">
                        <!-- Orders will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Products Content -->
            <div id="productsContent" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-box"></i> Quản lý sản phẩm</h2>
                    <button id="btnAddProduct" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Thêm sản phẩm
                    </button>
                </div>
                
                <!-- Search Bar -->
                <div class="search-container" style="margin-bottom: 2rem;">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="productSearchInput" placeholder="Tìm kiếm sản phẩm theo tên, danh mục hoặc mô tả..." onkeyup="searchProducts()">
                        <button type="button" id="clearSearchBtn" class="clear-search-btn" onclick="clearSearch()" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="search-stats" id="searchStats" style="margin-top: 0.5rem; font-size: 0.875rem; color: #666;">
                        <!-- Search results count will be shown here -->
                    </div>
                </div>
                
                <div id="productsList" class="products-grid">
                    <!-- Products will be loaded here -->
                </div>
            </div>

            <!-- Orders Content -->
            <div id="ordersContent" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-shopping-cart"></i> Quản lý đơn hàng</h2>
                </div>
                
                <div class="orders-table-container">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Sản phẩm</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Thời gian</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Accounts Content -->
            <div id="accountsContent" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-database"></i> Kho tài khoản</h2>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="accountProductFilter" class="filter-select" onchange="loadAccountsByProduct()">
                            <option value="">Chọn sản phẩm</option>
                        </select>
                        <button class="btn btn-primary" onclick="openAddAccountModal()">
                            <i class="fas fa-plus"></i> Thêm tài khoản
                        </button>
                    </div>
                </div>
                
                <div class="stat-cards-row">
                    <div class="stat-card-mini">
                        <div class="stat-icon-mini">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-info-mini">
                            <h4 id="totalStockProducts">0</h4>
                            <p>Sản phẩm có kho</p>
                        </div>
                    </div>
                    <div class="stat-card-mini">
                        <div class="stat-icon-mini">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="stat-info-mini">
                            <h4 id="totalStockAccounts">0</h4>
                            <p>Tổng tài khoản</p>
                        </div>
                    </div>
                </div>
                
                <div class="accounts-table-container">
                    <table class="accounts-table">
                        <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th>Gói/Option</th>
                                <th>Username</th>
                                <th>Password</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                            <!-- Accounts will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Content -->
            <div id="settingsContent" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-cog"></i> Cài đặt hệ thống</h2>
                </div>
                
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3><i class="fas fa-credit-card"></i> Cấu hình Sepay</h3>
                        <p>API Key và thông tin ngân hàng được cấu hình trong file <code>config.js</code></p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="testSepay()" style="flex: 1; min-width: 120px;">
                                <i class="fas fa-test"></i> Test Sepay
                            </button>
                            <button class="btn btn-secondary" onclick="testEmail()" style="flex: 1; min-width: 120px;">
                                <i class="fas fa-envelope"></i> Test Email
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                        <h3><i class="fas fa-paper-plane"></i> Cấu hình Telegram</h3>
                        <p>Bot Token và Chat ID được cấu hình trong file <code>config.js</code></p>
                        <button class="btn btn-secondary" onclick="testTelegram()">
                            <i class="fas fa-test"></i> Test Telegram
                        </button>
                    </div>
                    
                    <div class="settings-card">
                        <h3><i class="fas fa-database"></i> Cấu hình Database</h3>
                        <p>MongoDB Atlas connection string được cấu hình trong file <code>config.js</code></p>
                        <button class="btn btn-secondary" onclick="testDatabase()">
                            <i class="fas fa-test"></i> Test Database
                        </button>
                    </div>
                    
                    <div class="settings-card">
                        <h3><i class="fas fa-cloud"></i> Cấu hình Cloudflare Images</h3>
                        <p>API Token và Account ID được cấu hình trong file <code>config.js</code> hoặc environment variables</p>
                        <div id="cloudflareStatus" style="margin-bottom: 10px; padding: 8px; border-radius: 4px; display: none;">
                            <!-- Status sẽ được hiển thị ở đây -->
                        </div>
                        <button class="btn btn-secondary" onclick="testCloudflare()">
                            <i class="fas fa-test"></i> Test Cloudflare Images
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal" onclick="if(event.target.id === 'productModal') { document.getElementById('productModal').style.display='none'; document.getElementById('productModal').classList.remove('show', 'active'); }">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('productModal').style.display='none'; document.getElementById('productModal').classList.remove('show', 'active'); return false;">×</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="addAccountModal" class="modal" onclick="if(event.target.id === 'addAccountModal') { this.style.display='none'; this.classList.remove('show'); this.classList.remove('active'); }">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-modal" onclick="var m=document.getElementById('addAccountModal'); m.style.display='none'; m.classList.remove('show'); m.classList.remove('active'); return false;">×</span>
            <div id="addAccountModalBody">
                <h2><i class="fas fa-plus-circle"></i> Thêm Tài Khoản Vào Kho</h2>
                <form id="addAccountForm" onsubmit="submitAddAccount(event)">
                    <div class="form-group">
                        <label>Sản phẩm *</label>
                        <select id="addAccountProduct" class="form-input" required onchange="loadVariantsForAdd()">
                            <option value="">Chọn sản phẩm</option>
                        </select>
                    </div>
                    <div class="form-group" id="variantSelectGroup" style="display: none;">
                        <label>Gói/Option *</label>
                        <select id="addAccountVariant" class="form-input" required onchange="updateStockTypeForAdd()">
                            <option value="">Chọn gói</option>
                        </select>
                    </div>
                    <div class="form-group" id="stockTypeGroup" style="display: none;">
                        <label>Loại kho *</label>
                        <select id="addAccountStockType" class="form-input" required>
                            <option value="available">Có sẵn hàng</option>
                            <option value="contact">Cần liên hệ</option>
                        </select>
                        <small style="color:#666; font-size:0.75rem; display:block; margin-top:0.25rem;">
                            • Có sẵn hàng: Tự động thêm vào giỏ hàng<br>
                            • Cần liên hệ: Yêu cầu liên hệ trực tiếp
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" id="addAccountUsername" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label>Password *</label>
                        <input type="text" id="addAccountPassword" class="form-input" required>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary" style="flex:1;">
                            <i class="fas fa-save"></i> Lưu tài khoản
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="var m=document.getElementById('addAccountModal'); m.style.display='none'; m.classList.remove('show'); m.classList.remove('active'); document.getElementById('addAccountForm').reset(); return false;" style="flex:1;">
                            <i class="fas fa-times"></i> Hủy
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <script src="admin-products.js?v=20241227"></script>
    <script src="admin-script.js?v=20241227"></script>
    <script>
    // QUẢN LÝ KHO TÀI KHOẢN - SIÊU ĐƠN GIẢN
    let currentAccounts = [];
    // allProducts is declared in admin-products.js

    // Load all accounts from all products
    function loadAllAccounts() {
        fetch('/api/products')
            .then(r => r.json())
            .then(data => {
                if (data.success && data.products) {
                    allProducts = data.products;
                    // Load accounts for each product
                    const promises = data.products.map(product => 
                        fetch(`/api/products/${product.id}/accounts`, {
                            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('adminToken') }
                        }).then(r => r.json())
                    );
                    
                    return Promise.all(promises);
                }
            })
            .then(results => {
                currentAccounts = [];
                results.forEach((result, index) => {
                    if (result.success && result.accounts) {
                        result.accounts.forEach(acc => {
                            currentAccounts.push({
                                ...acc,
                                productName: allProducts[index].name
                            });
                        });
                    }
                });
                
                updateStockStats();
                renderAccountsTable();
            })
            .catch(err => {
                console.error('Lỗi tải accounts:', err);
                showNotification('Lỗi tải danh sách tài khoản', 'error');
            });
    }

    // Update stock statistics
    function updateStockStats() {
        const productCount = new Set(currentAccounts.map(acc => acc.productId)).size;
        const totalAccounts = currentAccounts.length;
        
        document.getElementById('totalStockProducts').textContent = productCount;
        document.getElementById('totalStockAccounts').textContent = totalAccounts;
    }

    // Render accounts table
    function renderAccountsTable() {
        const tbody = document.getElementById('accountsTableBody');
        if (!tbody) return;
        
        if (currentAccounts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #666;">Chưa có tài khoản nào trong kho</td></tr>';
            return;
        }
        
        tbody.innerHTML = currentAccounts.map(acc => `
            <tr>
                <td>${acc.productName}</td>
                <td>${acc.variantName || 'N/A'}</td>
                <td>${acc.username}</td>
                <td>${acc.password}</td>
                <td>
                    <span class="badge ${acc.status === 'available' ? 'badge-success' : 'badge-secondary'}">
                        ${acc.status === 'available' ? 'Có sẵn' : 'Đã bán'}
                    </span>
                </td>
                <td>
                    <button class="btn-icon" onclick="deleteAccount('${acc.productId}', '${acc._id}', '${acc.username}')" title="Xóa">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Open add account modal
    function openAddAccountModal() {
        // Load products for dropdown
        fetch('/api/products')
            .then(r => r.json())
            .then(data => {
                if (data.success && data.products) {
                    const select = document.getElementById('addAccountProduct');
                    select.innerHTML = '<option value="">Chọn sản phẩm</option>' +
                        data.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                }
            });
        
        const modal = document.getElementById('addAccountModal');
        modal.style.display = 'flex';
        modal.classList.add('show');
        document.getElementById('addAccountModal').classList.add('active');
    }

    // Close add account modal
    function closeAddAccountModal() {
        document.getElementById('addAccountModal').style.display = 'none';
        document.getElementById('addAccountModal').classList.remove('active');
        document.getElementById('addAccountForm').reset();
        document.getElementById('variantSelectGroup').style.display = 'none';
        document.getElementById('stockTypeGroup').style.display = 'none';
    }

    // Load variants for selected product
    function loadVariantsForAdd() {
        const productId = document.getElementById('addAccountProduct').value;
        const variantGroup = document.getElementById('variantSelectGroup');
        const stockTypeGroup = document.getElementById('stockTypeGroup');
        const variantSelect = document.getElementById('addAccountVariant');
        
        if (!productId) {
            variantGroup.style.display = 'none';
            stockTypeGroup.style.display = 'none';
            return;
        }
        
        const product = allProducts.find(p => p.id === productId);
        if (product && product.variants && product.variants.length > 0) {
            variantSelect.innerHTML = '<option value="">Chọn gói</option>' +
                product.variants.map((v, i) => `<option value="${i}">${i + 1} - ${v.name}</option>`).join('');
            variantGroup.style.display = 'block';
        } else {
            variantGroup.style.display = 'none';
            stockTypeGroup.style.display = 'none';
        }
    }

    // Update stock type when variant is selected
    function updateStockTypeForAdd() {
        const productId = document.getElementById('addAccountProduct').value;
        const variantIndex = document.getElementById('addAccountVariant').value;
        const stockTypeGroup = document.getElementById('stockTypeGroup');
        const stockTypeSelect = document.getElementById('addAccountStockType');
        
        if (!productId || !variantIndex) {
            stockTypeGroup.style.display = 'none';
            return;
        }
        
        const product = allProducts.find(p => p.id === productId);
        if (product && product.variants && product.variants[variantIndex]) {
            const variant = product.variants[variantIndex];
            stockTypeSelect.value = variant.stockType || 'available';
            stockTypeGroup.style.display = 'block';
        } else {
            stockTypeGroup.style.display = 'none';
        }
    }

    // Submit add account
    function submitAddAccount(event) {
        event.preventDefault();
        
        const productId = document.getElementById('addAccountProduct').value;
        const variantIndex = document.getElementById('addAccountVariant').value;
        const username = document.getElementById('addAccountUsername').value;
        const password = document.getElementById('addAccountPassword').value;
        const stockType = document.getElementById('addAccountStockType').value;
        
        if (!productId || !username || !password) {
            showNotification('Vui lòng điền đầy đủ thông tin', 'error');
            return;
        }
        
        const product = allProducts.find(p => p.id === productId);
        const variantName = product && product.variants && product.variants.length > 0 
            ? product.variants[variantIndex || 0].name 
            : 'default';
        
        // Backend expects 'accounts' as an array
        const accountData = {
            variantName: variantName,
            stockType: stockType,
            accounts: [{
                username: username,
                password: password
            }]
        };
        
        fetch(`/api/products/${productId}/stock`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
            },
            body: JSON.stringify(accountData)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showNotification('Đã thêm tài khoản vào kho', 'success');
                closeAddAccountModal();
                loadAllAccounts();
            } else {
                showNotification('Lỗi: ' + data.error, 'error');
            }
        })
        .catch(err => {
            console.error('Lỗi thêm tài khoản:', err);
            showNotification('Không thể thêm tài khoản', 'error');
        });
    }

    // Delete account
    function deleteAccount(productId, accountId, username) {
        if (!confirm(`Xóa tài khoản "${username}"?`)) return;
        
        fetch(`/api/products/${productId}/accounts/${accountId}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('adminToken') }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showNotification('Đã xóa tài khoản', 'success');
                loadAllAccounts();
            } else {
                showNotification('Lỗi: ' + data.error, 'error');
            }
        })
        .catch(err => {
            console.error('Lỗi xóa tài khoản:', err);
            showNotification('Không thể xóa tài khoản', 'error');
        });
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Load accounts when accounts tab is shown
        const accountsTab = document.querySelector('[data-page="accounts"]');
        if (accountsTab) {
            accountsTab.addEventListener('click', loadAllAccounts);
        }

        // Mobile menu toggle is handled in admin-script.js
    });
    </script>

    <!-- Image Editor Modal -->
    <div id="imageEditorModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 95vw; max-height: 95vh; width: 1200px;">
            <div class="modal-header">
                <h2><i class="fas fa-crop"></i> Cắt ảnh sản phẩm</h2>
                <button class="modal-close" onclick="closeImageEditor()">&times;</button>
            </div>
            
            <div class="fit-frame-container">
                <div class="crop-frame-container">
                    <div class="crop-frame" id="cropFrame">
                        <canvas id="cropCanvas" width="400" height="400"></canvas>
                        <div class="crop-overlay">
                            <div class="crop-border"></div>
                        </div>
                    </div>
                    <div class="crop-instructions">
                        <p><i class="fas fa-hand-paper"></i> Kéo để di chuyển ảnh</p>
                        <p><i class="fas fa-search-plus"></i> Zoom bằng chuột hoặc pinch</p>
                    </div>
                </div>
                
                <div class="crop-controls">
                    <div class="zoom-controls">
                        <h4><i class="fas fa-search"></i> Zoom</h4>
                        <div class="zoom-slider-container">
                            <button class="zoom-btn" onclick="zoomOut()">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="range" id="zoomSlider" min="0.5" max="3" step="0.1" value="1" 
                                   oninput="setZoom(this.value)">
                            <button class="zoom-btn" onclick="zoomIn()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="zoom-value">
                            <span id="zoomPercent">100%</span>
                        </div>
                    </div>
                    
                    <div class="crop-actions">
                        <button class="btn btn-secondary" onclick="resetImage()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="btn btn-primary" onclick="cropImage()">
                            <i class="fas fa-crop"></i> Cắt ảnh
                        </button>
                    </div>
                </div>
                
                <div class="crop-preview">
                    <h4><i class="fas fa-eye"></i> Xem trước</h4>
                    <div class="preview-container">
                        <canvas id="previewCanvas" width="200" height="200"></canvas>
                        <div id="noPreview" class="no-preview">
                            <i class="fas fa-image"></i>
                            <p>Chưa có ảnh đã cắt</p>
                        </div>
                    </div>
                    <button id="downloadBtn" class="btn btn-success" onclick="downloadCroppedImage()" disabled>
                        <i class="fas fa-download"></i> Tải xuống
                    </button>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImageEditor()">
                    <i class="fas fa-times"></i> Hủy
                </button>
                <button class="btn btn-primary" onclick="saveCroppedImage()">
                    <i class="fas fa-save"></i> Lưu ảnh
                </button>
            </div>
        </div>
    </div>
</body>
</html>
