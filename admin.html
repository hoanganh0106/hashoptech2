<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - HaShopTech</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <div class="login-header">
                <i class="fas fa-shield-alt"></i>
                <h1>Admin Panel</h1>
                <p>ƒêƒÉng nh·∫≠p ƒë·ªÉ qu·∫£n l√Ω h·ªá th·ªëng</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> M·∫≠t kh·∫©u</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
                </button>
            </form>
            <div id="loginError" class="error-message"></div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="dashboard-page" style="display: none;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-user-shield"></i>
                <span>Admin Panel</span>
            </div>
            <nav class="sidebar-menu">
                <a href="#" class="menu-item active" data-page="dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="menu-item" data-page="orders">
                    <i class="fas fa-shopping-cart"></i>
                    <span>ƒê∆°n h√†ng</span>
                </a>
                <a href="#" class="menu-item" data-page="products">
                    <i class="fas fa-box"></i>
                    <span>S·∫£n ph·∫©m</span>
                </a>
                <a href="#" class="menu-item" data-page="accounts">
                    <i class="fas fa-key"></i>
                    <span>Kho t√†i kho·∫£n</span>
                </a>
                <a href="#" class="menu-item" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span>C√†i ƒë·∫∑t</span>
                </a>
                <a href="#" class="menu-item" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>ƒêƒÉng xu·∫•t</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="content-header">
                <h2 id="pageTitle">Dashboard</h2>
                <div class="header-actions">
                    <span class="admin-name">
                        <i class="fas fa-user-circle"></i>
                        <span id="adminUsername">Admin</span>
                    </span>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div id="dashboardContent" class="content-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statTotalOrders">0</h3>
                            <p>T·ªïng ƒë∆°n h√†ng</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statPendingOrders">0</h3>
                            <p>Ch·ªù thanh to√°n</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statPaidOrders">0</h3>
                            <p>ƒê√£ thanh to√°n</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statRevenue">0ƒë</h3>
                            <p>Doanh thu</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statProducts">0</h3>
                            <p>S·∫£n ph·∫©m</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                            <i class="fas fa-key"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statAccounts">0</h3>
                            <p>T√†i kho·∫£n trong kho</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders Content -->
            <div id="ordersContent" class="content-section" style="display: none;">
                <div class="filter-bar">
                    <select id="orderStatusFilter" class="filter-select">
                        <option value="">T·∫•t c·∫£ ƒë∆°n h√†ng</option>
                        <option value="pending">Ch·ªù thanh to√°n</option>
                        <option value="paid">ƒê√£ thanh to√°n</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadOrders()">
                        <i class="fas fa-sync"></i> L√†m m·ªõi
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>M√£ ƒë∆°n</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>Email</th>
                                <th>S·ªë ti·ªÅn</th>
                                <th>Thanh to√°n</th>
                                <th>Giao h√†ng</th>
                                <th>Ng√†y t·∫°o</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="8" class="text-center">ƒêang t·∫£i...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Products Content -->
            <div id="productsContent" class="content-section" style="display: none;">
                <div class="filter-bar">
                    <button class="btn btn-primary" id="btnAddProduct">
                        <i class="fas fa-plus"></i> Th√™m s·∫£n ph·∫©m
                    </button>
                </div>
                <div class="products-grid" id="productsGrid">
                    <!-- Products will be loaded here -->
                </div>
            </div>

            <!-- Accounts Content -->
            <div id="accountsContent" class="content-section" style="display: none;">
                <div class="filter-bar" id="accountsFilterBar">
                    <select id="accountProductFilter" class="filter-select" onchange="loadAccountsByProduct()">
                        <option value="">Ch·ªçn s·∫£n ph·∫©m</option>
                    </select>
                    <select id="accountVariantFilter" class="filter-select" style="display:none;" onchange="loadAccountsByProduct()">
                        <option value="">T·∫•t c·∫£ g√≥i</option>
                    </select>
                    <select id="accountStatusFilter" class="filter-select" onchange="loadAccountsByProduct()">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="available">C√≤n h√†ng</option>
                        <option value="sold">ƒê√£ b√°n</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadAccountsByProduct()">
                        <i class="fas fa-sync"></i> L√†m m·ªõi
                    </button>
                </div>
                
                <!-- BUTTON RI√äNG BI·ªÜT - KH√îNG N·∫∞M TRONG FILTER BAR -->
                <div style="margin-bottom: 1rem;">
                    <div id="addAccountButtonContainer"></div>
                </div>
                
                <!-- Stock Summary -->
                <div id="stockSummary" class="stock-summary" style="display:none; margin-bottom: 1.5rem;">
                    <div class="stat-cards-row" id="variantStockCards"></div>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">STT</th>
                                <th>G√≥i</th>
                                <th>Username</th>
                                <th>Password</th>
                                <th>Th√¥ng tin th√™m</th>
                                <th style="width: 120px;">Tr·∫°ng th√°i</th>
                                <th style="width: 150px;">Ng√†y th√™m</th>
                                <th style="width: 100px;">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                            <tr>
                                <td colspan="8" class="text-center">Ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ xem t√†i kho·∫£n</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Content -->
            <div id="settingsContent" class="content-section" style="display: none;">
                <div class="settings-container">
                    <div class="settings-card">
                        <h3><i class="fas fa-lock"></i> ƒê·ªïi m·∫≠t kh·∫©u</h3>
                        <form id="changePasswordForm">
                            <div class="form-group">
                                <label>M·∫≠t kh·∫©u c≈©</label>
                                <input type="password" id="oldPassword" required>
                            </div>
                            <div class="form-group">
                                <label>M·∫≠t kh·∫©u m·ªõi</label>
                                <input type="password" id="newPassword" required>
                            </div>
                            <div class="form-group">
                                <label>X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                                <input type="password" id="confirmPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> ƒê·ªïi m·∫≠t kh·∫©u
                            </button>
                        </form>
                    </div>
                    <div class="settings-card">
                        <h3><i class="fab fa-telegram"></i> C·∫•u h√¨nh Telegram</h3>
                        <p>Bot Token v√† Chat ID ƒë∆∞·ª£c c·∫•u h√¨nh trong file <code>config.js</code></p>
                        <button class="btn btn-secondary" onclick="testTelegram()">
                            <i class="fas fa-test"></i> Test k·∫øt n·ªëi
                        </button>
                    </div>
                    <div class="settings-card">
                        <h3><i class="fas fa-credit-card"></i> C·∫•u h√¨nh Sepay</h3>
                        <p>API Key v√† th√¥ng tin ng√¢n h√†ng ƒë∆∞·ª£c c·∫•u h√¨nh trong file <code>config.js</code></p>
                        <button class="btn btn-secondary" onclick="testSepay()">
                            <i class="fas fa-test"></i> Test k·∫øt n·ªëi
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeOrderModal()">&times;</span>
            <div id="orderModalBody"></div>
        </div>
    </div>

    <!-- Product Modal (for add/edit product) -->
    <div id="productModal" class="modal" onclick="if(event.target === this) { this.style.display='none'; this.classList.remove('show'); }">
        <div class="modal-content">
            <span class="close-modal" id="closeModalBtn" onclick="document.getElementById('productModal').style.display='none'; document.getElementById('productModal').classList.remove('show'); return false;">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="addAccountModal" class="modal" onclick="if(event.target === this) { this.style.display='none'; this.classList.remove('active'); document.getElementById('addAccountForm').reset(); document.getElementById('variantSelectGroup').style.display='none'; }">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-modal" onclick="document.getElementById('addAccountModal').style.display='none'; document.getElementById('addAccountModal').classList.remove('active'); document.getElementById('addAccountForm').reset(); document.getElementById('variantSelectGroup').style.display='none'; return false;">&times;</span>
            <div id="addAccountModalBody">
                <h2><i class="fas fa-plus-circle"></i> Th√™m T√†i Kho·∫£n V√†o Kho</h2>
                <form id="addAccountForm" onsubmit="submitAddAccounts(event)">
                    <div class="form-group">
                        <label>S·∫£n ph·∫©m *</label>
                        <select id="addAccountProduct" class="form-input" required onchange="loadVariantsForAdd()">
                            <option value="">Ch·ªçn s·∫£n ph·∫©m</option>
                        </select>
                    </div>

                    <div class="form-group" id="variantSelectGroup" style="display:none;">
                        <label>G√≥i/Option *</label>
                        <select id="addAccountVariant" class="form-input" required>
                            <option value="">Ch·ªçn g√≥i</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            Danh s√°ch t√†i kho·∫£n *
                            <small style="color:#666; font-weight:normal;">(M·ªói d√≤ng: username|password ho·∫∑c username|password|ghi ch√∫)</small>
                        </label>
                        <textarea id="addAccountList" class="form-textarea" rows="10" required placeholder="user1@example.com|pass123&#10;user2@example.com|pass456|T√†i kho·∫£n VIP&#10;user3@example.com|pass789"></textarea>
                        <small style="color:#666;">
                            <i class="fas fa-info-circle"></i> 
                            M·ªói d√≤ng m·ªôt t√†i kho·∫£n, d√πng d·∫•u | ƒë·ªÉ ph√¢n c√°ch username, password v√† ghi ch√∫ (optional)
                        </small>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary" style="flex:1;">
                            <i class="fas fa-save"></i> L∆∞u t√†i kho·∫£n
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('addAccountModal').style.display='none'; document.getElementById('addAccountModal').classList.remove('active'); document.getElementById('addAccountForm').reset(); document.getElementById('variantSelectGroup').style.display='none'; return false;">
                            <i class="fas fa-times"></i> H·ªßy
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="admin-script.js"></script>
    <script src="admin-products.js"></script>
    <script src="admin-stock.js"></script>
    <script>
    // T·∫†O N√öT ƒê·ªòNG V·ªöI MUTATIONOBSERVER - SOLUTION CU·ªêI C√ôNG
    (function() {
        console.log('üöÄ Initializing Add Account Button with MutationObserver...');
        
        let currentButton = null;
        
        function createAddAccountButton() {
            const container = document.getElementById('addAccountButtonContainer');
            if (!container) {
                console.warn('‚ö†Ô∏è Container not found yet');
                return null;
            }
            
            // N·∫øu ƒë√£ c√≥ button v√† v·∫´n ho·∫°t ƒë·ªông, kh√¥ng t·∫°o l·∫°i
            if (currentButton && currentButton.parentNode === container && currentButton.onclick) {
                console.log('‚úÖ Button already exists and working');
                return currentButton;
            }
            
            console.log('üî® Creating new button...');
            
            // T·∫°o n√∫t m·ªõi ho√†n to√†n
            const button = document.createElement('button');
            button.className = 'btn btn-primary';
            button.id = 'btnAddAccountFinal';
            button.style.cssText = 'position: relative; z-index: 9999 !important; cursor: pointer !important; pointer-events: auto !important;';
            button.type = 'button';
            button.innerHTML = '<i class="fas fa-plus"></i> Th√™m t√†i kho·∫£n';
            
            // Attach click handler
            button.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('üéØ BUTTON CLICKED!');
                
                const modal = document.getElementById('addAccountModal');
                if (!modal) {
                    alert('Kh√¥ng t√¨m th·∫•y modal!');
                    return false;
                }
                
                modal.style.display = 'block';
                modal.classList.add('active');
                console.log('‚úÖ Modal opened');
                
                // Load products
                fetch(window.location.origin + '/api/products')
                    .then(r => r.json())
                    .then(data => {
                        if (data.success && data.products && data.products.length > 0) {
                            const select = document.getElementById('addAccountProduct');
                            if (select) {
                                select.innerHTML = '<option value="">Ch·ªçn s·∫£n ph·∫©m</option>' +
                                    data.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                                console.log('‚úÖ Products loaded:', data.products.length);
                            }
                        }
                    })
                    .catch(err => console.error('‚ùå Error:', err));
                
                return false;
            };
            
            // Clear v√† insert
            container.innerHTML = '';
            container.appendChild(button);
            currentButton = button;
            console.log('‚úÖ Button created successfully');
            
            return button;
        }
        
        // Setup MutationObserver ƒë·ªÉ t·ª± ƒë·ªông t·∫°o l·∫°i button
        function setupObserver() {
            const container = document.getElementById('addAccountButtonContainer');
            if (!container) {
                setTimeout(setupObserver, 100);
                return;
            }
            
            console.log('üëÅÔ∏è Setting up MutationObserver...');
            
            const observer = new MutationObserver(function(mutations) {
                console.log('üîÑ DOM changed, checking button...');
                // Ki·ªÉm tra button c√≤n t·ªìn t·∫°i kh√¥ng
                const btn = document.getElementById('btnAddAccountFinal');
                if (!btn || !btn.onclick) {
                    console.log('‚ö†Ô∏è Button missing or broken, recreating...');
                    createAddAccountButton();
                }
            });
            
            // Quan s√°t container v√† parent c·ªßa n√≥
            observer.observe(container, {
                childList: true,
                subtree: true,
                attributes: true
            });
            
            // Quan s√°t filter bar
            const filterBar = document.getElementById('accountsFilterBar');
            if (filterBar) {
                observer.observe(filterBar, {
                    childList: true,
                    subtree: true
                });
            }
            
            console.log('‚úÖ Observer active');
        }
        
        // Init
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                createAddAccountButton();
                setupObserver();
            });
        } else {
            createAddAccountButton();
            setupObserver();
        }
        
        // Hook navigate
        const originalNavigate = window.navigateToPage;
        window.navigateToPage = function(page) {
            if (typeof originalNavigate === 'function') {
                originalNavigate.apply(this, arguments);
            }
            if (page === 'accounts') {
                setTimeout(createAddAccountButton, 200);
            }
        };
        
        // Expose global
        window.forceRecreateAddAccountButton = createAddAccountButton;
        
        // T·∫°o l·∫°i button m·ªói 2 gi√¢y (fallback cu·ªëi c√πng)
        setInterval(function() {
            const btn = document.getElementById('btnAddAccountFinal');
            if (!btn || !btn.parentNode) {
                console.log('‚è∞ Periodic check: button missing, recreating...');
                createAddAccountButton();
            }
        }, 2000);
    })();
    </script>
</body>
</html>

